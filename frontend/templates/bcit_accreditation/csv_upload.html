{% extends 'bcit_accreditation/base.html' %}

{% block title %}Upload CSV - BCIT Accreditation System{% endblock %}

{% block content %}
{% load static %}
<link rel="stylesheet" href="{% static 'css/csv_upload.css' %}">
<div class="container">
    <h1>CSV Upload</h1>

    <div class="row">
        <div class="col-12">
            <form id="csvUploadForm" enctype="multipart/form-data">
                {% csrf_token %}
                <h3>Upload Course Data</h3>

                <p>Use this page to upload course data in CSV format to the BCIT Accreditation System.</p>

                <label for="csv_file">Select CSV File</label>
                <input class="form-control" type="file" id="csv_file" name="csv_file" accept=".csv" required>

                <label for="file_type">Data Type</label>
                <select class="form-control" id="file_type" name="file_type" required>
                    <option value="" selected disabled>Select data type</option>
                    <option value="course">Course Data</option>
                    <option value="student">Student Data</option>
                    <option value="program">Program Data</option>
                    <option value="accreditation">Accreditation Metrics</option>
                </select>

                <button type="submit" class="btn btn-primary">Upload CSV</button>
            </form>

            <!-- Upload Status -->
            <div id="uploadStatus" class="alert d-none" role="alert"></div>

            <!-- Template Info -->
            <div>
                <h4>CSV Templates</h4>
                <p>Download the template for the data you want to upload:</p>
                <div>
                    <a href="#">Course Template</a> | 
                    <a href="#">Student Template</a> | 
                    <a href="#">Program Template</a> | 
                    <a href="#">Accreditation Template</a>
                </div>
            </div>

            <!-- Upload History -->
            <div>
                <h4>Recent Uploads</h4>
                <table>
                    <thead>
                        <tr>
                            <th>Filename</th>
                            <th>Data Type</th>
                            <th>Upload Date</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>courses_spring2025.csv</td>
                            <td>Course Data</td>
                            <td>May 6, 2025</td>
                            <td><span class="success">Success</span></td>
                        </tr>
                        <tr>
                            <td>program_metrics.csv</td>
                            <td>Program Data</td>
                            <td>May 5, 2025</td>
                            <td><span class="success">Success</span></td>
                        </tr>
                        <tr>
                            <td>accred_data_2025.csv</td>
                            <td>Accreditation Metrics</td>
                            <td>May 3, 2025</td>
                            <td><span class="failed">Failed</span></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('csvUploadForm');
    const statusDiv = document.getElementById('uploadStatus');
    
    form.addEventListener('submit', function(event) {
        event.preventDefault();
        
        const fileInput = document.getElementById('csv_file');
        const fileTypeSelect = document.getElementById('file_type');
        const file = fileInput.files[0];
        const fileType = fileTypeSelect.value;
        
        if (!file) {
            showStatus('Please select a CSV file to upload.', 'danger');
            return;
        }
        
        if (!file.name.endsWith('.csv')) {
            showStatus('File must be a CSV format.', 'danger');
            return;
        }
        
        if (!fileType) {
            showStatus('Please select a data type.', 'danger');
            return;
        }
        
        // Create form data for upload
        const formData = new FormData();
        formData.append('csv_file', file);
        formData.append('file_type', fileType);
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        
        // Show loading status
        showStatus('Uploading file... Please wait.', 'info');
        
        // Send AJAX request
        fetch(window.location.href, {
            method: 'POST',
            body: formData,
            credentials: 'same-origin'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showStatus(data.message, 'success');
                // Reset the form on success
                form.reset();
                // Refresh the page after 2 seconds to show the updated upload history
                setTimeout(() => {
                    location.reload();
                }, 2000);
            } else {
                showStatus(data.message, 'danger');
            }
        })
        .catch(error => {
            showStatus('Error uploading file: ' + error.message, 'danger');
        });
    });
    
    function showStatus(message, type) {
        statusDiv.textContent = message;
        statusDiv.classList.remove('d-none', 'alert-success', 'alert-danger', 'alert-info');
        statusDiv.classList.add('alert-' + type);
        
        // For better UX, add an animated fade-in effect
        statusDiv.style.opacity = 0;
        statusDiv.classList.remove('d-none');
        
        // Fade in
        let opacity = 0;
        const timer = setInterval(() => {
            opacity += 0.1;
            statusDiv.style.opacity = opacity;
            if (opacity >= 1) clearInterval(timer);
        }, 30);
        
        // Auto-hide success messages after 5 seconds
        if (type === 'success') {
            setTimeout(() => {
                // Fade out
                let opacity = 1;
                const timer = setInterval(() => {
                    opacity -= 0.1;
                    statusDiv.style.opacity = opacity;
                    if (opacity <= 0) {
                        clearInterval(timer);
                        statusDiv.classList.add('d-none');
                    }
                }, 30);
            }, 5000);
        }
    }
});
</script>
{% endblock %}
