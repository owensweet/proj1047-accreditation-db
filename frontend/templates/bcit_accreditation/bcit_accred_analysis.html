{% extends 'bcit_accreditation/base.html' %}

{% block title %}Analysis - BCIT Accreditation System{% endblock %}

{% block extra_css %}
{% load static %}
<link rel="stylesheet" href="{% static 'css/analysis.css' %}">
{% endblock %}

{% block content %}
<div class="analysismain">
    <div class="analysis-title">
        BCIT Accreditation Analysis
    </div>

    <!-- Tab Navigation -->
    <div class="analysis-tabs">
        <div class="analysis-tab active" data-tab="program">Program Overview</div>
        <div class="analysis-tab" data-tab="courses">Course Data</div>
        <div class="analysis-tab" data-tab="faculty">Faculty Info</div>
        <div class="analysis-tab" data-tab="assessment">Assessment Validity</div>
        <div class="analysis-tab" data-tab="accreditation">Accreditation Reports</div>
    </div>
    
    <!-- Program Overview Tab Content -->
    <div class="analysis-content active" id="program-content">
        <div class="visualization-container">
            <div class="visualization-title">Program Performance Overview</div>
            <div class="tableau-container" id="program-overview-viz">
                <div class="loading-indicator">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
        
        <div class="visualization-container">
            <div class="visualization-title">Program CI Metrics</div>
            <div class="tableau-container" id="program-ci-viz">
                <div class="loading-indicator">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Course Data Tab Content -->
    <div class="analysis-content" id="courses-content">
        <div class="visualization-container">
            <div class="visualization-title">Course Distribution</div>
            <div class="tableau-container" id="course-distribution-viz">
                <div class="loading-indicator">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
        
        <div class="visualization-container">
            <div class="visualization-title">Course Metrics Comparison</div>
            <div class="tableau-container" id="course-metrics-viz">
                <div class="loading-indicator">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Faculty Info Tab Content -->
    <div class="analysis-content" id="faculty-content">
        <div class="visualization-container">
            <div class="visualization-title">Faculty CI Distribution</div>
            <div class="tableau-container" id="faculty-ci-viz">
                <div class="loading-indicator">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Assessment Validity Tab Content -->
    <div class="analysis-content" id="assessment-content">
        <div class="visualization-container">
            <div class="visualization-title">Assessment Validity Metrics</div>
            <div class="tableau-container" id="assessment-validity-viz">
                <div class="loading-indicator">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Accreditation Reports Tab Content -->
    <div class="analysis-content" id="accreditation-content">
        <div class="visualization-container">
            <div class="visualization-title">Accreditation Reports Summary</div>
            <div class="tableau-container" id="accred-reports-viz">
                <div class="loading-indicator">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
        
        <div class="visualization-container">
            <div class="visualization-title">Annual Reports Summary</div>
            <div class="tableau-container" id="annual-reports-viz">
                <div class="loading-indicator">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://public.tableau.com/javascripts/api/tableau-2.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Tab switching functionality
    const tabs = document.querySelectorAll('.analysis-tab');
    tabs.forEach(tab => {
        tab.addEventListener('click', function() {
            // Remove active class from all tabs and content
            document.querySelectorAll('.analysis-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.analysis-content').forEach(c => c.classList.remove('active'));
            
            // Add active class to clicked tab and corresponding content
            const tabName = this.getAttribute('data-tab');
            this.classList.add('active');
            document.getElementById(tabName + '-content').classList.add('active');
            
            // Resize any Tableau visualizations in the newly active tab
            resizeTableauVizs();
        });
    });
    
    // Initialize Tableau visualizations
    initTableauVizs();
    
    // Handle window resize to adjust Tableau visualizations
    window.addEventListener('resize', resizeTableauVizs);
});

// Object to store all Tableau visualizations
let tableauVizs = {};

// Function to initialize Tableau visualizations
function initTableauVizs() {
    // Define vizs with their container IDs and Tableau URLs
    const vizConfigs = [
        {
            containerId: 'program-overview-viz', 
            tableauUrl: 'https://public.tableau.com/views/ProgramOverview/Dashboard1'
        },
        {
            containerId: 'program-ci-viz', 
            tableauUrl: 'https://public.tableau.com/views/ProgramCI/Dashboard1'
        },
        {
            containerId: 'course-distribution-viz', 
            tableauUrl: 'https://public.tableau.com/views/CourseDistribution/Dashboard1'
        },
        {
            containerId: 'course-metrics-viz', 
            tableauUrl: 'https://public.tableau.com/views/CourseMetrics/Dashboard1'
        },
        {
            containerId: 'faculty-ci-viz', 
            tableauUrl: 'https://public.tableau.com/views/FacultyCI/Dashboard1'
        },
        {
            containerId: 'assessment-validity-viz', 
            tableauUrl: 'https://public.tableau.com/views/AssessmentValidity/Dashboard1'
        },
        {
            containerId: 'accred-reports-viz', 
            tableauUrl: 'https://public.tableau.com/views/AccreditationReports/Dashboard1'
        },
        {
            containerId: 'annual-reports-viz', 
            tableauUrl: 'https://public.tableau.com/views/AnnualReports/Dashboard1'
        }
    ];
    
    // Load each visualization
    vizConfigs.forEach(config => {
        loadTableauViz(config.containerId, config.tableauUrl);
    });
}

// Function to load a Tableau visualization
function loadTableauViz(containerId, tableauUrl) {
    const containerDiv = document.getElementById(containerId);
    
    if (!containerDiv) return;
    
    try {
        const options = {
            hideTabs: true,
            hideToolbar: true,
            width: '100%',
            height: '600px',
            onFirstInteractive: function() {
                console.log(containerId + " loaded successfully");
            }
        };
        
        // Create the visualization
        containerDiv.innerHTML = '';
        tableauVizs[containerId] = new tableau.Viz(containerDiv, tableauUrl, options);
    } catch (error) {
        console.error("Error loading Tableau visualization:", error);
        containerDiv.innerHTML = '<div class="error-message">Error loading visualization. Please try again later.</div>';
    }
}

// Function to resize Tableau visualizations
function resizeTableauVizs() {
    for (const [containerId, viz] of Object.entries(tableauVizs)) {
        const container = document.getElementById(containerId);
        if (container && viz) {
            try {
                viz.setFrameSize(
                    container.offsetWidth,
                    container.offsetHeight
                );
            } catch (error) {
                console.error("Error resizing Tableau visualization:", error);
            }
        }
    }
}
</script>
{% endblock %}