{% extends 'bcit_accreditation/base.html' %}

{% block title %}Admin Dashboard - BCIT Accreditation System{% endblock %}

{% block extra_css %}
<style>
    /* Main admin container */
    .admin-container {
        padding: 20px;
        background-color: #f9f9f9;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin: 20px 0;
    }
    
    /* Tab styling */
    .admin-tabs {
        display: flex;
        border-bottom: 2px solid #173d68;
        margin-bottom: 20px;
    }
    
    .admin-tab {
        padding: 10px 20px;
        cursor: pointer;
        font-weight: bold;
        background-color: #e9ecef;
        border: 1px solid #dee2e6;
        border-bottom: none;
        margin-right: 5px;
        border-radius: 5px 5px 0 0;
        transition: all 0.3s ease;
    }
    
    .admin-tab:hover {
        background-color: #dee2e6;
    }
    
    .admin-tab.active {
        background-color: #173d68;
        color: white;
        border-color: #173d68;
    }
    
    /* Tab content */
    .tab-content {
        display: none;
    }
    
    .tab-content.active {
        display: block;
    }
    
    /* Database view container */
    .database-container {
        max-height: 600px;
        overflow-y: auto;
        border: 1px solid #e0e0e0;
    }
    
    .database-table {
        width: 100%;
        border-collapse: collapse;
        table-layout: fixed;
    }
    
    .database-table th, .database-table td {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 150px; /* Limit column width */
    }
    
    .database-table th {
        position: sticky;
        top: 0;
        z-index: 10;
        background-color: #173d68;
        color: white;
        padding: 10px;
        text-align: left;
    }
    
    .database-table td {
        padding: 8px;
        border-bottom: 1px solid #e0e0e0;
    }
    
    .database-table tr:nth-child(even) {
        background-color: #f2f2f2;
    }
    
    .stats-card {
        transition: transform 0.3s;
    }
    
    .stats-card:hover {
        transform: translateY(-5px);
    }
    
    /* Sorting styles */
    .sortable {
        cursor: pointer;
        user-select: none;
    }
    
    .sortable:hover {
        background-color: #0d5cb1;
    }
    
    .sortable::after {
        content: ' ↕';
        font-size: 0.8em;
        color: #fff;
    }
    
    .sort-asc::after {
        content: ' ↑';
        color: #fff;
    }
    
    .sort-desc::after {
        content: ' ↓';
        color: #fff;
    }
    
    /* Export button container */
    .exportbuttoncontainer {
        margin: 20px 0;
        padding: 15px;
        background-color: #e9f7ef;
        border-radius: 5px;
        border-left: 4px solid #2ecc71;
    }
    
    .export-btn {
        background-color: #2ecc71;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
        transition: background-color 0.3s;
        display: inline-flex;
        align-items: center;
    }
    
    .export-btn:hover {
        background-color: #27ae60;
    }
    
    .export-btn i {
        margin-right: 8px;
    }
    
    /* Pagination styling */
    .pagination-controls {
        margin-top: 15px;
    }
    
    .pagination-controls button {
        margin: 0 5px;
    }
    
    #current-page {
        margin: 0 10px;
        font-weight: bold;
    }
    
    /* Loading indicator */
    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }
    
    .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="admin-container">
    <h2 class="mb-4">Admin Dashboard</h2>
    
    <!-- Export Button Container -->
    <div class="exportbuttoncontainer">
        <h4>Export Data</h4>
        <p>Export all database records to an Excel file for offline analysis.</p>
        <a href="{% url 'export' %}" class="export-btn">
            <i class="fas fa-file-export"></i> Export to Excel
        </a>
    </div>
    
    <!-- Tab Navigation -->
    <div class="admin-tabs">
        <div class="admin-tab active" data-tab="users">Users</div>
        <div class="admin-tab" data-tab="database">Database</div>
    </div>
    
    <!-- Table Admin Content Container -->
    <div class="tableadmincontent">
        <!-- Users Tab Content -->
        <div id="users-tab" class="tab-content active">
            <!-- User Management Table -->
            <div class="card mb-4">

                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">User Management</h5>
                </div>

                <div class="card-body">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th class="sortable" data-sort="username">Username</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th class="sortable" data-sort="last_upload">Last Upload Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="user-table-body">
                            {% if users %}
                                {% for user in users %}
                                    <tr>
                                        <td>{{ user.username }}</td>
                                        <td>{{ user.email }}</td>
                                        <td>{{ user.profile.role|default:"Faculty" }}</td>
                                        <td>{{ user.last_upload|default:"No uploads" }}</td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-primary">View</button>
                                        </td>
                                    </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="5" class="text-center">No users found</td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>

            </div>   

            <!-- Recent Activities and Admin Tools -->
            <div class="row">
                <div class="col-md-6">
                    <div class="card mb-4">

                        <div class="card-header">
                            <i class="fas fa-table me-1"></i>
                            Recent Activities
                        </div>

                        <div class="card-body">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>User</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% if activities %}
                                        {% for activity in activities %}
                                            <tr>
                                                <td>{{ activity.date }}</td>
                                                <td>{{ activity.user }}</td>
                                                <td>{{ activity.action }}</td>
                                            </tr>
                                        {% endfor %}
                                    {% else %}
                                        <tr>
                                            <td colspan="3" class="text-center">No recent activities</td>
                                        </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>
        </div>
        
        <!-- Database Tab Content -->
        <div id="database-tab" class="tab-content">
            <div class="card mb-4">

                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Full Database Explorer</h5>
                    <div>
                        <select id="table-selector" class="form-select form-select-sm">
                            <option value="data_process">Data Process</option>
                            <option value="faculty_ci">Faculty CI</option>
                            <option value="program_ci">Program CI</option>
                            <option value="assess_validity">Assessment Validity</option>
                            <option value="accred_report">Accreditation Reports</option>
                            <option value="annual_report">Annual Reports</option>
                        </select>
                    </div>
                </div>

                <div class="card-body p-0">
                    <div class="database-container">
                        <table class="database-table" id="data-table">
                            <thead>
                                <tr>
                                    <th class="sortable" data-sort="id">ID</th>
                                    <th class="sortable" data-sort="term">Term</th>
                                    <th class="sortable" data-sort="program">Program</th>
                                    <th class="sortable" data-sort="course">Course</th>
                                    <th class="sortable" data-sort="prog_term">Program Term</th>
                                    <th class="sortable" data-sort="instr_first_name">Faculty First Name</th>
                                    <th class="sortable" data-sort="instr_last_name">Faculty Last Name</th>
                                    <th class="sortable" data-sort="ga">Graduate Attribute</th>
                                    <th class="sortable" data-sort="gai">GAI</th>
                                    <th class="sortable" data-sort="instr_level">Instructional Level</th>
                                    <th class="sortable" data-sort="alignment">Assessment Alignment</th>
                                    <th class="sortable" data-sort="clos">Course Learning Outcomes</th>
                                    <th class="sortable" data-sort="assess_type">Assessment Type</th>
                                    <th class="sortable" data-sort="assess_weight">Assessment Weight</th>
                                    <th class="sortable" data-sort="assess_max">Assessment Max Score</th>
                                    <th class="sortable" data-sort="total_score">Total Score</th>
                                    <th class="sortable" data-sort="question_max">Question Max</th>
                                    <th class="sortable" data-sort="gai_score">GAI Score</th>
                                    <th class="sortable" data-sort="assess_title">Assessment Title</th>
                                    <th class="sortable" data-sort="assess_descript">Assessment Description</th>
                                    <th class="sortable" data-sort="quest_text">Question Text</th>
                                    <th class="sortable" data-sort="student_id">Student ID</th>
                                    <th class="sortable" data-sort="instr_comments">Comments</th>
                                </tr>
                            </thead>
                            <tbody id="data-table-body">
                                {% if database_entries %}
                                    {% for entry in database_entries %}
                                        <tr>
                                            <td>{{ entry.id }}</td>
                                            <td>{{ entry.term }}</td>
                                            <td>{{ entry.program }}</td>
                                            <td>{{ entry.course }}</td>
                                            <td>{{ entry.prog_term }}</td>
                                            <td>{{ entry.instr_first_name }}</td>
                                            <td>{{ entry.instr_last_name }}</td>
                                            <td>{{ entry.ga }}</td>
                                            <td>{{ entry.gai }}</td>
                                            <td>{{ entry.instr_level }}</td>
                                            <td>{{ entry.alignment }}</td>
                                            <td>{{ entry.clos }}</td>
                                            <td>{{ entry.assess_type }}</td>
                                            <td>{{ entry.assess_weight }}</td>
                                            <td>{{ entry.assess_max }}</td>
                                            <td>{{ entry.total_score }}</td>
                                            <td>{{ entry.question_max }}</td>
                                            <td>{{ entry.gai_score }}</td>
                                            <td>{{ entry.assess_title }}</td>
                                            <td>{{ entry.assess_descript }}</td>
                                            <td>{{ entry.quest_text }}</td>
                                            <td>{{ entry.student_id }}</td>
                                            <td>{{ entry.instr_comments }}</td>
                                        </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="23" class="text-center">No database entries found</td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Add pagination controls -->
                <div class="pagination-controls mt-3 d-flex justify-content-between align-items-center">
                    <div>
                        <span>Showing <span id="showing-start">1</span>-<span id="showing-end">10</span> of <span id="total-records">0</span> records</span>
                    </div>
                    <div>
                        <button id="prev-page" class="btn btn-sm btn-outline-primary" disabled>&laquo; Previous</button>
                        <span id="current-page">Page 1</span>
                        <button id="next-page" class="btn btn-sm btn-outline-primary">Next &raquo;</button>
                    </div>
                    <div>
                        <select id="page-size" class="form-select form-select-sm">
                            <option value="10">10 per page</option>
                            <option value="25">25 per page</option>
                            <option value="50">50 per page</option>
                            <option value="100">100 per page</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Tab switching functionality
        const tabs = document.querySelectorAll('.admin-tab');
        const tabContents = document.querySelectorAll('.tab-content');
        
        tabs.forEach(tab => {
            tab.addEventListener('click', function() {
                // Remove active class from all tabs and contents
                tabs.forEach(t => t.classList.remove('active'));
                tabContents.forEach(c => c.classList.remove('active'));
                
                // Add active class to selected tab and content
                this.classList.add('active');
                const tabId = this.getAttribute('data-tab');
                document.getElementById(tabId + '-tab').classList.add('active');
            });
        });
        
        // Handle table sorting in users tab
        const tableHeaders = document.querySelectorAll('th.sortable');
        let sortField = null;
        let sortDirection = 'asc';
        
        tableHeaders.forEach(header => {
            header.addEventListener('click', function() {
                const field = this.dataset.sort;
                
                // Toggle direction if same field clicked again
                if (field === sortField) {
                    sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    sortField = field;
                    sortDirection = 'asc';
                }
                
                // Update UI to show sorting state
                tableHeaders.forEach(h => {
                    h.classList.remove('sort-asc', 'sort-desc');
                });
                
                this.classList.add(sortDirection === 'asc' ? 'sort-asc' : 'sort-desc');
                
                // Sort the table
                sortTable(field, sortDirection);
            });
        });
        
        function sortTable(field, direction) {
            const tbody = document.getElementById('user-table-body');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            
            if (rows.length <= 1) return; // No need to sort if only one or no rows
            
            rows.sort((a, b) => {
                let valueA, valueB;
                
                if (field === 'username') {
                    valueA = a.cells[0].textContent.trim().toLowerCase();
                    valueB = b.cells[0].textContent.trim().toLowerCase();
                } else if (field === 'last_upload') {
                    // Handle "No uploads" text
                    const dateA = a.cells[3].textContent.trim();
                    const dateB = b.cells[3].textContent.trim();
                    
                    valueA = dateA === 'No uploads' ? '1900-01-01' : dateA;
                    valueB = dateB === 'No uploads' ? '1900-01-01' : dateB;
                }
                
                // Standard comparison
                if (valueA < valueB) return direction === 'asc' ? -1 : 1;
                if (valueA > valueB) return direction === 'asc' ? 1 : -1;
                return 0;
            });
            
            // Remove all rows from table
            while (tbody.firstChild) {
                tbody.removeChild(tbody.firstChild);
            }
            
            // Add sorted rows
            rows.forEach(row => {
                tbody.appendChild(row);
            });
        }
        
        // Table selector for database tab
        let currentPage = 1;
        let pageSize = 10;
        let totalPages = 1;
        let totalRecords = 0;
        let currentTable = 'data_process';
        let sortColumn = 'id';
        let sortOrder = 'asc';

        const tableSelector = document.getElementById('table-selector');
        if (tableSelector) {
            tableSelector.addEventListener('change', function() {
                currentTable = this.value;
                currentPage = 1; // Reset to first page
                loadTableData();
            });
        }

        // Pagination controls
        document.getElementById('prev-page').addEventListener('click', function() {
            if (currentPage > 1) {
                currentPage--;
                loadTableData();
            }
        });

        document.getElementById('next-page').addEventListener('click', function() {
            if (currentPage < totalPages) {
                currentPage++;
                loadTableData();
            }
        });

        document.getElementById('page-size').addEventListener('change', function() {
            pageSize = parseInt(this.value);
            currentPage = 1; // Reset to first page
            loadTableData();
        });

        // Sorting functionality for database table
        document.querySelectorAll('#data-table th.sortable').forEach(header => {
            header.addEventListener('click', function() {
                const column = this.dataset.sort;
                
                // Toggle sort order or set new column
                if (column === sortColumn) {
                    sortOrder = sortOrder === 'asc' ? 'desc' : 'asc';
                } else {
                    sortColumn = column;
                    sortOrder = 'asc';
                }
                
                // Update UI to show sorting state
                document.querySelectorAll('#data-table th').forEach(th => {
                    th.classList.remove('sort-asc', 'sort-desc');
                });
                
                this.classList.add(sortOrder === 'asc' ? 'sort-asc' : 'sort-desc');
                
                // Reload data with new sorting
                loadTableData();
            });
        });

        // Initial data load
        loadTableData();

        // Function to load table data via AJAX
        function loadTableData() {
            showLoading();
            
            // Construct the API URL with pagination and sorting parameters
            const url = `/api/data/${currentTable}?page=${currentPage}&page_size=${pageSize}&sort_by=${sortColumn}&sort_order=${sortOrder}`;
            
            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    hideLoading();
                    updateDataTable(data.results);
                    updatePagination(data.pagination);
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                    hideLoading();
                    document.getElementById('data-table-body').innerHTML = 
                        '<tr><td colspan="18" class="text-center">Error loading data. Please try again.</td></tr>';
                });
        }

        // Function to show loading overlay
        function showLoading() {
            const container = document.querySelector('.database-container');
            const existingOverlay = container.querySelector('.loading-overlay');
            
            if (!existingOverlay) {
                const overlay = document.createElement('div');
                overlay.className = 'loading-overlay';
                overlay.innerHTML = '<div class="spinner"></div>';
                container.style.position = 'relative';
                container.appendChild(overlay);
            }
        }

        // Function to hide loading overlay
        function hideLoading() {
            const overlay = document.querySelector('.loading-overlay');
            if (overlay) {
                overlay.remove();
            }
        }

        // Function to update pagination info
        function updatePagination(pagination) {
            if (!pagination) return;
            
            totalPages = pagination.total_pages;
            totalRecords = pagination.total_records;
            
            document.getElementById('showing-start').textContent = pagination.start_record;
            document.getElementById('showing-end').textContent = pagination.end_record;
            document.getElementById('total-records').textContent = pagination.total_records;
            document.getElementById('current-page').textContent = `Page ${currentPage}`;
            
            // Enable/disable prev/next buttons
            document.getElementById('prev-page').disabled = currentPage === 1;
            document.getElementById('next-page').disabled = currentPage >= totalPages;
        }

        // Function to update the data table with new data
        function updateDataTable(data) {
            const tableBody = document.getElementById('data-table-body');
            tableBody.innerHTML = '';
            
            if (!data || data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="18" class="text-center">No data available</td></tr>';
                return;
            }
            
            data.forEach(entry => {
                const row = document.createElement('tr');
                
                // Create cells for each field
                row.innerHTML = `
                    <td>${entry.id || ''}</td>
                    <td>${entry.term || ''}</td>
                    <td>${entry.program || ''}</td>
                    <td>${entry.course || ''}</td>
                    <td>${entry.assess_type || ''}</td>
                    <td>${entry.assess_descript || ''}</td>
                    <td>${entry.ga || ''}</td>
                    <td>${entry.gai || ''}</td>
                    <td>${entry.quest_text || ''}</td>
                    <td>${entry.ga || ''}</td>
                    <td>${entry.gai || ''}</td>
                    <td>${entry.alignment || ''}</td>
                    <td>${entry.assess_title || ''}</td>
                    <td>${entry.assess_max || ''}</td>
                    <td>${entry.assess_weight || ''}</td>
                    <td>${entry.student_id || ''}</td>
                    <td>${entry.gai_score || ''}</td>
                    <td>${entry.question_max || ''}</td>
                `;
                
                tableBody.appendChild(row);
            });
        }
        
        // Export to Excel functionality
        document.getElementById('exportButton').addEventListener('click', function() {
            exportToExcel();
        });
        
        function exportToExcel() {
            // Show loading state
            const exportButton = document.getElementById('exportButton');
            const originalButtonText = exportButton.innerHTML;
            exportButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Exporting...';
            exportButton.disabled = true;
            
            // In a real implementation, fetch all data to export
            // For this example, we'll use the currently visible table
            setTimeout(() => {
                try {
                    // Determine which table is currently visible
                    const activeTab = document.querySelector('.admin-tab.active').getAttribute('data-tab');
                    let tableElement;
                    
                    if (activeTab === 'users') {
                        tableElement = document.querySelector('.table.table-striped.table-hover');
                    } else if (activeTab === 'database') {
                        tableElement = document.getElementById('data-table');
                    }
                    
                    if (!tableElement) {
                        throw new Error('No table found to export');
                    }
                    
                    // Convert table to worksheet
                    const wb = XLSX.utils.book_new();
                    const ws = XLSX.utils.table_to_sheet(tableElement);
                    
                    // Add worksheet to workbook
                    XLSX.utils.book_append_sheet(wb, ws, 'Data Export');
                    
                    // Generate filename with current date
                    const date = new Date();
                    const dateStr = date.toISOString().split('T')[0];
                    const filename = `bcit_accreditation_data_${dateStr}.xlsx`;
                    
                    // Save the file
                    XLSX.writeFile(wb, filename);
                    
                    // Restore button state
                    exportButton.innerHTML = originalButtonText;
                    exportButton.disabled = false;
                    
                    // Show success notification
                    alert('Export completed successfully!');
                } catch (error) {
                    console.error('Export failed:', error);
                    exportButton.innerHTML = originalButtonText;
                    exportButton.disabled = false;
                    alert('Export failed. Please try again.');
                }
            }, 1000); // Simulate processing time
        }
    });
</script>
{% endblock %}